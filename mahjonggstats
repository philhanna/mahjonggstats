#! /usr/bin/python3

import os.path
import statistics
from datetime import *

class HistoryList:
    """ History records for this user
    """
    DEFAULT_FILENAME = os.path.expanduser('~/.local/share/gnome-mahjongg/history')

    def __init__(self):
        self.filename = HistoryList.DEFAULT_FILENAME
        self.levels = {}
        self.earliestDate = None
        self.latestDate = None
        with open(self.filename, "rt") as f:
            for line in f:
                history = History(line)
                if self.earliestDate == None or history.date < self.earliestDate:
                    self.earliestDate = history.date
                if self.latestDate == None or history.date > self.latestDate:
                    self.latestDate = history.date
                level = history.level
                recordList = self.getRecordList(level)
                recordList.add(history)

        self.count = 0
        for level in self.levels:
            recordList = self.getRecordList(level)
            recordList.sort()
            self.count += recordList.getCount()

    def getRecordList(self, level):
        if level not in self.levels:
            self.levels[level] = RecordList()
        return self.levels[level]

    def getCount(self):
        return self.count

class RecordList:
    """ A list of records at a particular level
    """
    def __init__(self):
        self.records = []
        self.count = 0

    def add(self, history):
        self.records.append(history)
        self.count += 1

    def sort(self):
        self.records.sort(key=lambda history: history.seconds)

    def getRecords(self):
        return self.records

    def getCount(self):
        return self.count

    def getMean(self):
        times = [h.seconds for h in self.records]
        mean = statistics.mean(times)
        return History.formatTime(mean)

class History:
    """ A single record in mahjongg history

        The file is located at ~/.local/share/gnome-mahjongg/history
    """

    @staticmethod
    def formatTime(seconds):
        seconds = int(seconds)
        mm = seconds // 60
        ss = seconds % 60
        return "{0:02d}:{1:02d}".format(mm, ss)

    def __init__(self, line):
        tokens = line.split()
        self.date = datetime.strptime(tokens[0], '%Y-%m-%dT%H:%M:%S%z')
        self.level = tokens[1]
        self.seconds = int(tokens[2])

    def __str__(self):
        return ("{date}: {time}".format(
            date=self.date.strftime("%m/%d/%Y"),
            time=self.secondsAsMMSS()
        ))

    def secondsAsMMSS(self):
        return History.formatTime(self.seconds)

if __name__ == '__main__':
    
    historyList = HistoryList()

    print("\nMahjongg history of {count} games from {start} to {end}".format(
        count=historyList.getCount(),
        start=historyList.earliestDate.strftime("%m/%d/%Y"),
        end=historyList.latestDate.strftime("%m/%d/%Y")
        ))
    levelNames = [key for key in historyList.levels.keys()]
    levelNames.sort()
    for level in levelNames:
        recordList = historyList.getRecordList(level)
        print("\n{count} games at level '{level}'".
            format(
                count=recordList.getCount(),
                level=level
                )
                )
        print("    mean = {}".format(recordList.getMean()))
        print("    top five scores:")
        for history in recordList.getRecords()[:5]:
            print("        {}".format(history))
    print()
